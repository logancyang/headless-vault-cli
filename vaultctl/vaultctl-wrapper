#!/bin/bash
#
# vaultctl-wrapper - SSH forced-command wrapper for vaultctl
#
# This script is used as the forced command in ~/.ssh/authorized_keys
# to restrict SSH access to only vaultctl commands.
#
# Usage in authorized_keys:
#   command="/path/to/vaultctl-wrapper",no-port-forwarding,no-X11-forwarding,no-agent-forwarding ssh-ed25519 AAAA...
#
# The wrapper:
#   1. Reads SSH_ORIGINAL_COMMAND (the command the client tried to run)
#   2. Validates it starts with "vaultctl"
#   3. Executes the command if valid, rejects otherwise
#

set -euo pipefail

# Save caller-provided env vars before sourcing config (allows test overrides)
_CALLER_VAULT_ROOT="${VAULT_ROOT:-}"
_CALLER_VAULTCTL_PATH="${VAULTCTL_PATH:-}"
_CALLER_VAULTCTL_LOG="${VAULTCTL_LOG:-}"

# Source config file if it exists (sets VAULT_ROOT, VAULTCTL_PATH, etc.)
CONFIG_FILE="$HOME/.config/vaultctl/config"
if [[ -f "$CONFIG_FILE" ]]; then
    source "$CONFIG_FILE"
fi

# Caller-provided env vars take precedence over config file
VAULT_ROOT="${_CALLER_VAULT_ROOT:-$VAULT_ROOT}"
VAULTCTL_PATH="${_CALLER_VAULTCTL_PATH:-${VAULTCTL_PATH:-/usr/local/bin/vaultctl}}"
LOG_FILE="${_CALLER_VAULTCTL_LOG:-${VAULTCTL_LOG:-/tmp/vaultctl.log}}"
export VAULT_ROOT

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') $*" >> "$LOG_FILE"
}

reject() {
    local reason="$1"
    log "REJECTED: $reason (command: ${SSH_ORIGINAL_COMMAND:-<none>})"
    echo '{"error": "command rejected", "reason": "'"$reason"'"}' >&2
    exit 1
}

# SSH_ORIGINAL_COMMAND contains the command the client tried to run
if [[ -z "${SSH_ORIGINAL_COMMAND:-}" ]]; then
    reject "no command provided"
fi

# Reject shell metacharacters to prevent injection attacks.
# Valid vaultctl args are subcommands, flags, paths, and base64 strings,
# none of which require these characters.
if [[ "$SSH_ORIGINAL_COMMAND" =~ [\;\|\&\$\`\(\)\{\}\<\>\\] ]]; then
    reject "illegal characters in command"
fi

# Parse into array safely (splits on whitespace, no glob expansion)
read -ra cmd_parts <<< "$SSH_ORIGINAL_COMMAND"

# First element must be "vaultctl"
if [[ "${cmd_parts[0]}" != "vaultctl" ]]; then
    reject "only vaultctl commands allowed"
fi

# Block admin commands that should only run locally
if [[ "${cmd_parts[1]:-}" == "set-root" ]]; then
    reject "set-root is not allowed remotely"
fi

log "ALLOWED: $SSH_ORIGINAL_COMMAND"

# Pass remaining args individually (no eval, no unquoted expansion)
exec "$VAULTCTL_PATH" "${cmd_parts[@]:1}"
